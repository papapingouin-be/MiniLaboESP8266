<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>MiniLabo Dashboard</title>
  <link rel="stylesheet" href="styles.css">
  <!--
    TODO: Implémenter une boîte de dialogue de connexion (popup PIN).
    À l’ouverture du tableau de bord, vérifier la présence d’un
    cookie de session. Si absent, afficher un formulaire demandant
    le code PIN configuré dans general.json. En cas de réussite,
    stocker un cookie et masquer la popup. Cette logique n’est pas
    encore implémentée.
  -->
</head>
<body>
  <h1>MiniLabo Dashboard</h1>
  <nav>
    <a href="dmm.html">Multimètre</a>
    <a href="funcgen.html">Générateur</a>
    <a href="io.html">Entrées/Sorties</a>
    <a href="logs.html">Logs</a>
    <a href="bench.html">BenchTest</a>
      <a href="devices.html">Console</a>
    <a href="network.html">Réseau</a>
    <a href="udp.html">UDP</a>
    <a href="scope-config.html">Oscillo</a>
    <a href="writequeue.html">FileQueue</a>
  </nav>
  <p>Bienvenue sur votre MiniLabo. Utilisez le menu ci‑dessus pour accéder aux différents modules.</p>
  <!-- Modal de connexion PIN -->
  <div id="login-modal" style="position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:1000;">
    <div style="background:#0f172a; border:1px solid #243047; border-radius:12px; padding:16px; width:320px; color:#e5e7eb;">
      <h3 style="margin:0 0 8px 0;">Connexion</h3>
      <p style="margin:0 0 10px 0; color:#94a3b8;">Entrez le code PIN de session.</p>
      <input id="pin-input" type="password" inputmode="numeric" pattern="\\d{4}" maxlength="4"
            style="width:100%; padding:8px; border-radius:8px; border:1px solid #334155; background:#0c121b; color:#e5e7eb" placeholder="1234">
      <div id="login-error" style="margin-top:8px; min-height:18px; color:#fca5a5;"></div>
      <div style="display:flex; gap:8px; margin-top:12px; justify-content:flex-end;">
        <button id="login-cancel" type="button"
                style="padding:8px 12px; border-radius:8px; border:1px solid #334155; background:#0b1220; color:#e5e7eb;">Annuler</button>
        <button id="login-submit" type="button"
                style="padding:8px 12px; border-radius:8px; border:1px solid #1f3b2f; background:#13261d; color:#bff6dd;">Valider</button>
      </div>
    </div>
  </div>

 <script>
(function(){
  const modal   = document.getElementById('login-modal');
  const input   = document.getElementById('pin-input');
  const submit  = document.getElementById('login-submit');
  const cancelB = document.getElementById('login-cancel');
  const errorEl = document.getElementById('login-error');

  function hasValidCookie() {
    // simple cookie flag; adapte si tu génères un token
    return document.cookie.split('; ').some(c => c.startsWith('mlsession=1'));
  }
  function setCookieOK() {
    document.cookie = "mlsession=1; Max-Age=86400; Path=/; SameSite=Lax";
  }
  function showModal(){ modal.style.display = 'flex'; input.value=''; errorEl.textContent=''; setTimeout(()=>input.focus(), 50); }
  function hideModal(){ modal.style.display = 'none'; }

  async function doLogin() {
    let pin = (input.value||'').trim();
    pin = pin.replace(/\D/g, '');
    if (pin.length !== 4) {
      errorEl.textContent = 'Le code PIN doit contenir exactement 4 chiffres.';
      return;
    }
    errorEl.textContent = '';

    // ENVOI JSON + lecture UNE fois
    let resp, data;
    try {
      resp = await fetch('/api/login', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ pin })
      });
      // Lis la réponse une seule fois (pas de double .json())
      const text = await resp.text();
      try { data = JSON.parse(text); } catch(e){ data = { ok:false, error:'bad json', raw:text }; }
    } catch (e) {
      errorEl.textContent = 'Erreur réseau. ('+ e +')';
      return;
    }

    if (resp.ok && data && data.ok === true) {
      setCookieOK();
      hideModal();
    } else {
      errorEl.textContent = (data && data.error) ? ('PIN invalide ('+data.error+')') : 'PIN invalide';
    }
  }

  // Ouvre le modal si pas de cookie
  window.addEventListener('DOMContentLoaded', ()=>{
    if (!hasValidCookie()) showModal();
  });

  // Bind
  submit.addEventListener('click', doLogin);
  cancelB.addEventListener('click', hideModal);
  input.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') doLogin(); });

  // Option: touche ESC pour fermer
  document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape' && modal.style.display === 'flex') hideModal(); });
})();
</script>

</body>
</html>