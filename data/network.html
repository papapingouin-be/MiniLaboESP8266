<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Configuration R√©seau ‚Äì MiniLabo</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    body {
      font-family: sans-serif;
      margin: 2rem;
      line-height: 1.5;
    }
    fieldset {
      margin-bottom: 1.5rem;
      border-radius: 0.5rem;
      padding: 1rem 1.5rem;
      border: 1px solid #ccc;
    }
    legend {
      font-weight: bold;
      padding: 0 0.5rem;
    }
    label {
      display: block;
      margin: 0.5rem 0;
    }
    .hidden {
      display: none;
    }
    .inline {
      display: inline-flex;
      align-items: center;
      gap: 0.75rem;
    }
    .help {
      font-size: 0.9rem;
      color: #444;
      margin: 0.25rem 0 0;
    }
    #networks {
      margin-top: 0.75rem;
      max-height: 12rem;
      overflow: auto;
      border: 1px solid #ccc;
      border-radius: 0.5rem;
      padding: 0.5rem;
    }
    #networks button {
      width: 100%;
      text-align: left;
      margin-bottom: 0.25rem;
      padding: 0.5rem;
      border: 1px solid #ddd;
      border-radius: 0.5rem;
      background: #f6f6f6;
      cursor: pointer;
    }
    #networks button:hover {
      background: #e9f2ff;
    }
    #status {
      margin-top: 1rem;
      min-height: 1.5rem;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <h1>Configuration r√©seau</h1>
  <p>
    Cette page permet de choisir le mode WiFi du MiniLabo, de configurer la connexion
    station (STA) ou le point d‚Äôacc√®s (AP) int√©gr√© et d‚Äôenregistrer les param√®tres
    vers l‚Äôappareil.
  </p>
  <form id="net-form">
    <fieldset>
      <legend>Mode WiFi</legend>
      <label class="inline"><input type="radio" name="mode" value="ap" checked> Point d‚Äôacc√®s (AP)</label>
      <label class="inline"><input type="radio" name="mode" value="sta"> Station (STA)</label>
      <p id="mode-help" class="help"></p>
    </fieldset>

    <fieldset id="sta-section" class="hidden">
      <legend>Connexion station (STA)</legend>
      <p>Choisissez un r√©seau existant ou saisissez un SSID manuellement.</p>
      <div class="inline">
        <button type="button" id="scan">Scanner les r√©seaux WiFi</button>
        <span id="scan-status" aria-live="polite"></span>
      </div>
      <div id="networks" class="hidden" aria-live="polite" aria-label="R√©seaux WiFi disponibles"></div>
      <label>
        SSID station
        <input type="text" name="ssid" autocomplete="off" placeholder="Nom du r√©seau">
      </label>
      <label>
        Mot de passe station
        <input type="password" name="password" autocomplete="off" placeholder="Mot de passe du r√©seau">
      </label>
      <label class="inline">
        <input type="checkbox" id="sta-hidden"> Le SSID n‚Äôest pas diffus√©
      </label>
      <p class="help">Si le SSID est masqu√©, saisissez-le exactement comme configur√© sur votre routeur.</p>
    </fieldset>

    <fieldset id="ap-section" class="hidden">
      <legend>Point d‚Äôacc√®s int√©gr√© (AP)</legend>
      <p>D√©finissez ici les param√®tres du point d‚Äôacc√®s cr√©√© par le MiniLabo.</p>
      <label>
        SSID du point d‚Äôacc√®s
        <input type="text" name="ap_ssid" autocomplete="off" placeholder="Nom du point d‚Äôacc√®s">
      </label>
      <label>
        Mot de passe du point d‚Äôacc√®s
        <input type="password" name="ap_password" autocomplete="off" placeholder="Au moins 8 caract√®res">
      </label>
      <p class="help">Le mot de passe doit contenir au minimum 8 caract√®res pour respecter la norme WPA2.</p>
    </fieldset>

    <fieldset>
      <legend>Administration</legend>
      <label>
        Adresse IP (optionnelle)
        <input type="text" name="ip" placeholder="ex : 192.168.1.42">
      </label>
      <label>
        Passerelle
        <input type="text" name="gateway" placeholder="ex : 192.168.1.1">
      </label>
      <label>
        Masque de sous-r√©seau
        <input type="text" name="netmask" placeholder="ex : 255.255.255.0">
      </label>
      <label>
        Code PIN (4 chiffres)
        <input type="password" name="login_pin" inputmode="numeric" pattern="[0-9]{4}" maxlength="4" autocomplete="off" placeholder="1234">
      </label>
      <p class="help">Ce code s√©curise l‚Äôacc√®s au tableau de bord web. Il doit comporter exactement 4 chiffres.</p>
      <p class="help">Laissez les champs vides pour obtenir une configuration dynamique via DHCP.</p>
    </fieldset>

    <div class="inline">
      <button type="submit">Enregistrer la configuration</button>
      <button type="button" id="reload">Recharger</button>
    </div>
  </form>
  <p id="status" aria-live="polite"></p>

  <script>
  function updateModeHelp(mode) {
    const help = document.getElementById('mode-help');
    if (mode === 'sta') {
      help.textContent = 'Le MiniLabo se connectera √† votre r√©seau WiFi existant.';
    } else {
      help.textContent = 'Le MiniLabo cr√©era son propre r√©seau WiFi accessible depuis vos appareils.';
    }
  }

  function toggleSections(mode) {
    document.getElementById('sta-section').classList.toggle('hidden', mode !== 'sta');
    document.getElementById('ap-section').classList.toggle('hidden', mode !== 'ap');
    updateModeHelp(mode);
  }

  async function loadNetworkConfig() {
    setStatus('Chargement de la configuration‚Ä¶');
    try {
      const response = await fetch('/api/config?area=network');
      if (!response.ok) throw new Error('HTTP ' + response.status);
      const cfg = await response.json();
      const form = document.getElementById('net-form');
      const mode = cfg.mode || 'ap';
      form.elements['mode'].value = mode;
      form.querySelectorAll('input[name="mode"]').forEach(radio => {
        radio.checked = (radio.value === mode);
      });
      form.elements['ssid'].value = cfg.ssid || '';
      form.elements['password'].value = cfg.password || '';
      form.elements['ap_ssid'].value = cfg.ap_ssid || '';
      form.elements['ap_password'].value = cfg.ap_password || '';
      form.elements['ip'].value = cfg.ip || '';
      form.elements['gateway'].value = cfg.gateway || '';
      form.elements['netmask'].value = cfg.netmask || '';
      form.elements['login_pin'].value = cfg.login_pin || '';
      document.getElementById('sta-hidden').checked = !!cfg.sta_hidden;
      toggleSections(mode);
      setStatus('Configuration charg√©e.');
    } catch (err) {
      console.warn('Failed to load network config', err);
      setStatus('Impossible de charger la configuration r√©seau.', true);
    }
  }

  async function saveNetworkConfig(event) {
    event.preventDefault();
    const form = document.getElementById('net-form');
    const pinRaw = (form.elements['login_pin'].value || '').trim();
    if (!/^\d{4}$/.test(pinRaw)) {
      setStatus('Le code PIN doit contenir exactement 4 chiffres.', true);
      form.elements['login_pin'].focus();
      return;
    }
    const data = {
      mode: form.elements['mode'].value,
      ssid: form.elements['ssid'].value,
      password: form.elements['password'].value,
      ap_ssid: form.elements['ap_ssid'].value,
      ap_password: form.elements['ap_password'].value,
      ip: form.elements['ip'].value,
      gateway: form.elements['gateway'].value,
      netmask: form.elements['netmask'].value,
      sta_hidden: document.getElementById('sta-hidden').checked,
      login_pin: pinRaw
    };

    setStatus('Enregistrement en cours‚Ä¶');
    try {
      const response = await fetch('/api/config?area=network', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      if (!response.ok) throw new Error('HTTP ' + response.status);
      setStatus('Configuration enregistr√©e avec succ√®s.');
    } catch (err) {
      console.warn('Failed to save network config', err);
      setStatus('√âchec de l‚Äôenregistrement de la configuration.', true);
    }
  }

  async function scanNetworks() {
    const btn = document.getElementById('scan');
    const list = document.getElementById('networks');
    const status = document.getElementById('scan-status');
    btn.disabled = true;
    status.textContent = 'Scan en cours‚Ä¶';
    list.innerHTML = '';
    list.classList.add('hidden');
    try {
      const response = await fetch('/api/wifi/scan');
      if (!response.ok) throw new Error('HTTP ' + response.status);
      const networks = await response.json();
      if (!Array.isArray(networks) || networks.length === 0) {
        status.textContent = 'Aucun r√©seau trouv√©.';
      } else {
        status.textContent = networks.length + ' r√©seau(x) d√©tect√©(s). Cliquez pour s√©lectionner.';
        list.classList.remove('hidden');
        networks.sort((a, b) => (b.rssi || 0) - (a.rssi || 0));
        for (const net of networks) {
          const button = document.createElement('button');
          const secure = net.secure ?? (typeof net.encryption === 'string' ? net.encryption.toLowerCase() !== 'open' : undefined);
          const securityIcon = secure === false ? 'üîì' : 'üîí';
          const securityLabel = typeof net.encryption === 'string' ? net.encryption : (secure === false ? 'Ouvert' : 'S√©curis√©');
          const channel = net.channel != null ? `CH ${net.channel}` : '';
          const requiresPassword = secure !== false;
          button.type = 'button';
          const parts = [
            net.ssid || '<SSID masqu√©>',
            `${securityIcon} ${securityLabel}`,
            channel,
            `RSSI ${net.rssi ?? '?'} dBm`
          ].filter(Boolean);
          button.textContent = parts.join(' ¬∑ ');
          button.addEventListener('click', () => {
            document.querySelector('input[name="ssid"]').value = net.ssid || '';
            document.getElementById('sta-hidden').checked = !net.ssid;
            if (requiresPassword) {
              document.querySelector('input[name="password"]').focus();
            }
          });
          list.appendChild(button);
        }
      }
    } catch (err) {
      console.warn('Failed to scan networks', err);
      status.textContent = 'Erreur pendant le scan WiFi.';
    } finally {
      btn.disabled = false;
    }
  }

  function setStatus(message, isError = false) {
    const status = document.getElementById('status');
    status.textContent = message;
    status.style.color = isError ? '#b00020' : '#184a2c';
  }

  document.getElementById('net-form').addEventListener('submit', saveNetworkConfig);
  document.getElementById('reload').addEventListener('click', loadNetworkConfig);
  document.getElementById('scan').addEventListener('click', scanNetworks);
  document.querySelectorAll('input[name="mode"]').forEach(radio => {
    radio.addEventListener('change', () => toggleSections(radio.value));
  });

  const checkedMode = document.querySelector('input[name="mode"]:checked');
  toggleSections(checkedMode ? checkedMode.value : 'ap');

  loadNetworkConfig();
  </script>
</body>
</html>
